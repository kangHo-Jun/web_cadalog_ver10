# Cafe24 OAuth 구조 개선 검증 요청 (0213)

## 📌 목적

Cafe24 OAuth 토큰 만료 및 환경 변수 불일치로 인한 장애 재발 방지를 위한
구조 개선안에 대한 기술 검증 요청

------------------------------------------------------------------------

## 🔎 현재까지 확인된 문제

### 1️⃣ 환경 변수 명명 불일치

-   코드: `CAFE24_MALL_ID`
-   실제 env: `MALL_ID`
-   결과: `undefined.cafe24api.com` 요청 발생

### 2️⃣ Refresh Token 만료 (2주 정책)

-   장기간 API 호출 없음
-   refresh_token 만료 → `invalid_grant`
-   authorization_code 재발급 필요

### 3️⃣ `.env` / `.env.local` 이중 관리

-   일부 스크립트는 `.env` 참조
-   Next 서버는 `.env.local` 참조
-   토큰 갱신 후 서버는 구 토큰 사용

------------------------------------------------------------------------

## 🎯 제안하는 개선안 (기술 검증 요청)

### 1️⃣ 환경 변수 단일화

-   `.env.local`만 사용
-   모든 스크립트에서:

``` js
require('dotenv').config({ path: '.env.local' })
```

-   `.env` 파일 제거

**검토 요청:** dev + prod 환경 모두에서 안정적인지 평가

------------------------------------------------------------------------

### 2️⃣ 토큰 저장소 단일화

현재: - 토큰이 `.env` 파일과 Redis에 혼재

개선안: - 토큰을 Redis 또는 DB 단일 저장소에만 저장 - 서버 시작 시 해당
저장소에서 로드 - 파일 기반 토큰 저장 제거

**검토 요청:** 운영 환경 기준 최적 구조 제안

------------------------------------------------------------------------

### 3️⃣ Refresh Token 생존 유지 전략

제안: - Vercel Cron 또는 GitHub Actions로 `/api/sync-products` 주 1회
호출 - refresh_token 자동 회전 유지

**검토 요청:** Cafe24 정책상 정기 사용 시 refresh_token 만료 연장 여부
확인

------------------------------------------------------------------------

### 4️⃣ 만료 감지 및 경고 시스템

제안: - `expires_at = now + expires_in` 계산 후 Redis 저장 - 만료 3일 전
경고 - 만료 1일 전 Slack 알림

**검토 요청:** refresh_token TTL을 API 응답에서 확보 가능한지 확인

------------------------------------------------------------------------

### 5️⃣ 중앙 에러 핸들링 구조

현재: - 401 → refresh → 실패 → 중단

개선안: - Axios 인터셉터 기반 중앙 처리 - refresh 실패 시 알림 + 장애
로그 기록

**검토 요청:** 서버사이드 권장 패턴 제안

------------------------------------------------------------------------

## 🔍 요청 사항

1.  위 구조의 기술적 타당성 평가
2.  보안 리스크 분석
3.  더 적합한 대안 제시
4.  장기 운영 기준 권장 아키텍처 설계안

------------------------------------------------------------------------

작성일: 2025-02-13 목적: OAuth 구조 안정화 및 재발 방지
