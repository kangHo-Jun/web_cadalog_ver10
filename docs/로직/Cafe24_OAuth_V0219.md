# Cafe24 OAuth í† í° ê´€ë¦¬ ì‹œìŠ¤í…œ (ê³µì‹ ê¸°ì¤€ ì™„ì „ ì •í•© ë²„ì „)

ì‘ì„± ê¸°ì¤€: Cafe24 ê³µì‹ OAuth retoken ì •ì±…

------------------------------------------------------------------------

## ğŸ“Œ í•µì‹¬ ì›ì¹™ (ê³µì‹ ê¸°ì¤€)

1.  access_tokenì€ ì•½ 2ì‹œê°„ ìœ íš¨
2.  refresh_tokenì€ ìµœëŒ€ 14ì¼ ìœ íš¨ (ê³ ì • ë§Œë£Œ)
3.  refresh ìš”ì²­ ì‹œ ìƒˆë¡œìš´ access_token + refresh_token ì„¸íŠ¸ê°€ ë°˜í™˜ë¨
4.  ê¸°ì¡´ refresh_tokenì€ ì¦‰ì‹œ íê¸°ë¨ (êµì²´ ëª¨ë¸)
5.  refresh_token ë§Œë£Œ ì‹œ authorization_code ì¬ë°œê¸‰ í•„ìš”
6.  refresh_token ìˆ˜ëª…ì€ API í˜¸ì¶œë¡œ ì—°ì¥ë˜ì§€ ì•ŠìŒ

------------------------------------------------------------------------

## ğŸ¯ ìµœì¢… ì•„í‚¤í…ì²˜

### 1ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ (.env)

.envì—ëŠ” **í† í°ì„ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤**

    CAFE24_MALL_ID=daesan3833
    CAFE24_CLIENT_ID=...
    CAFE24_CLIENT_SECRET=...
    CAFE24_REDIRECT_URI=https://your-domain.com/api/auth/callback
    KV_REDIS_URL=redis://...

âŒ access_token ì €ì¥ ê¸ˆì§€\
âŒ refresh_token ì €ì¥ ê¸ˆì§€

------------------------------------------------------------------------

### 2ï¸âƒ£ Redis ì €ì¥ êµ¬ì¡°

Key: cafe24:oauth:{mall_id}

``` json
{
  "access_token": "...",
  "expires_at": 1700000000000,
  "refresh_token": "...",
  "refresh_token_expires_at": 1701200000000
}
```

-   expires_at = now + expires_in
-   refresh_token_expires_at = now + refresh_token_expires_in

------------------------------------------------------------------------

## ğŸ”„ í† í° ë™ì‘ íë¦„

### API ìš”ì²­ ì‹œ

1.  Redisì—ì„œ í† í° ë¡œë“œ
2.  access_token ë§Œë£Œ ì—¬ë¶€ í™•ì¸
3.  ë§Œë£Œ ì „ â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
4.  ë§Œë£Œ ì‹œ â†’ refresh_tokenìœ¼ë¡œ ì¬ë°œê¸‰ ìš”ì²­
5.  ìƒˆ í† í° ì„¸íŠ¸ Redis ì €ì¥
6.  ì›ë˜ ìš”ì²­ ì¬ì‹œë„

------------------------------------------------------------------------

### Refresh ìš”ì²­ ë°©ì‹ (ê³µì‹)

POST /api/v2/oauth/token

Headers: Authorization: Basic base64(client_id:client_secret)
Content-Type: application/x-www-form-urlencoded

Body: grant_type=refresh_token refresh_token=...

------------------------------------------------------------------------

## â— refresh_token ë§Œë£Œ ëŒ€ì‘

refresh_tokenì€ 14ì¼ ê³ ì • ë§Œë£Œ.

ë§Œë£Œ ì‹œ: - invalid_grant ë°˜í™˜ - ìë™ ë³µêµ¬ ë¶ˆê°€ - authorization_code
ì¬ë°œê¸‰ í•„ìš”

------------------------------------------------------------------------

## ğŸ› ë§Œë£Œ ì•Œë¦¼ ì „ëµ

Cron (í•˜ë£¨ 1íšŒ ì‹¤í–‰):

1.  Redisì˜ refresh_token_expires_at ì¡°íšŒ
2.  D-3 â†’ Slack/Email ê²½ê³ 
3.  D-1 â†’ ì¬ê²½ê³ 
4.  ë§Œë£Œ â†’ NEEDS_REAUTH ìƒíƒœ ì„¤ì •

------------------------------------------------------------------------

## ğŸ” ì¬ì¸ì¦ í”„ë¡œì„¸ìŠ¤

### 1ï¸âƒ£ /api/auth/cafe24/start

â†’ Cafe24 authorize URLë¡œ redirect

### 2ï¸âƒ£ /api/auth/cafe24/callback

â†’ code ìˆ˜ì‹  â†’ ì¦‰ì‹œ token êµí™˜ (codeëŠ” 1ë¶„ ìœ íš¨) â†’ Redis ì €ì¥

------------------------------------------------------------------------

## ğŸš¨ ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ

### access ë§Œë£Œ

â†’ ìë™ refresh

### refresh ë§Œë£Œ

â†’ NEEDS_REAUTH ìƒíƒœ ê¸°ë¡ â†’ ê´€ë¦¬ì ì¬ì¸ì¦ ìš”ì²­

------------------------------------------------------------------------

## ğŸ“Š ìš´ì˜ ëª¨ë¸ ìš”ì•½

  í•­ëª©                 ìë™   ìˆ˜ë™
  -------------------- ------ --------------
  access_token ê°±ì‹     âœ…     ì—†ìŒ
  refresh_token ê°±ì‹    âŒ     14ì¼ë§ˆë‹¤ 1íšŒ

------------------------------------------------------------------------

## ğŸ¯ ìµœì¢… ê²°ë¡ 

Cafe24 ì •ì±…ìƒ ì™„ì „ ìë™ ì˜êµ¬ ìœ ì§€ êµ¬ì¡°ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.

í˜„ì‹¤ì ì´ê³  ê³µì‹ì— ì •í•©ëœ êµ¬ì¡°ëŠ”:

-   access_token ìë™ ê°±ì‹ 
-   refresh_token ë§Œë£Œ ì „ ì•Œë¦¼
-   2ì£¼ë§ˆë‹¤ 1íšŒ ì¬ì¸ì¦

ì´ êµ¬ì¡°ê°€ ê°€ì¥ ì•ˆì •ì ì´ê³  ê³µì‹ ì •ì±…ì— ì™„ì „íˆ ë¶€í•©í•œë‹¤.

------------------------------------------------------------------------

## ğŸ“§ ë§Œë£Œ ì•Œë¦¼ ì‹œìŠ¤í…œ (ìë™)

**Vercel Cron**ì´ ë§¤ì¼ ìì •(KST 09:00)ì— `/api/cron/check-token-expiry`ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

-   ë§Œë£Œ **2ì¼ ì „**: `zartkang@gmail.com`ìœ¼ë¡œ ê²½ê³  ë©”ì¼ ë°œì†¡
-   ë©”ì¼ ìˆ˜ì‹  í›„ **ì•„ë˜ ì¬ì¸ì¦ ì ˆì°¨** ì§„í–‰

------------------------------------------------------------------------

## ğŸ”‘ ì¬ì¸ì¦ ì ˆì°¨ (ë©”ì¼ ìˆ˜ì‹  í›„ í•´ì•¼ í•  ì¼)

### 1ë‹¨ê³„ â€” ë§í¬ í´ë¦­ & ìŠ¹ì¸ (1ë¶„)

ë¸Œë¼ìš°ì €ì—ì„œ ì•„ë˜ URL ì ‘ì†:

```
https://daesan3833.cafe24api.com/api/v2/oauth/authorize?response_type=code&client_id=5TbJGxFqFBOtlYEXoWL47D&redirect_uri=https://web-cadalog-ver10.vercel.app/api/auth/callback&scope=mall.read_product,mall.write_product
```

â†’ Cafe24 ë¡œê·¸ì¸ â†’ **[ìŠ¹ì¸] ë²„íŠ¼ í´ë¦­**

### 2ë‹¨ê³„ â€” code ë³µì‚¬ (10ì´ˆ)

ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ URLì—ì„œ `code=` ë’¤ì˜ ê°’ì„ ë³µì‚¬í•©ë‹ˆë‹¤.

```
https://web-cadalog-ver10.vercel.app/api/auth/callback?code=XXXXXXXXXXXXXXX
                                                              â†‘ ì´ ë¶€ë¶„ ë³µì‚¬
```

### 3ë‹¨ê³„ â€” AIì—ê²Œ ì „ë‹¬ (10ì´ˆ)

Antigravity AI ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ê¸°:

```
authorization_code: ë³µì‚¬í•œì½”ë“œ
```

â†’ ë‚˜ë¨¸ì§€ëŠ” **AIê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬**í•©ë‹ˆë‹¤. (í† í° êµí™˜, í™˜ê²½ë³€ìˆ˜ ê°±ì‹ , Redis ì €ì¥, ë°ì´í„° ë™ê¸°í™”)

### âš ï¸ ì£¼ì˜ì‚¬í•­

-   `code`ëŠ” ë°œê¸‰ í›„ **1ë¶„ ì´ë‚´** ì œì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
-   ë§í¬ í´ë¦­ â†’ ë³µì‚¬ â†’ AI ì „ë‹¬ê¹Œì§€ ë¹ ë¥´ê²Œ ì§„í–‰í•˜ì„¸ìš”.
-   ë‹¤ìŒ ë§Œë£Œì¼: **2026ë…„ 3ì›” 5ì¼ (ì˜¤í›„ 5:26 KST)**


