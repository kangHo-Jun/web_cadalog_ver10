<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>제품 카탈로그 - 대장간</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="products_data.js"></script>
  <script src="categories_data.js"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fadeIn 0.5s ease-out; }
    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="w-full max-w-6xl mx-auto p-6 space-y-8 animate-in bg-white min-h-screen">
    <!-- Header & Filter -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div>
        <h1 class="text-3xl font-bold tracking-tight bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
          제품 카탈로그
        </h1>
        <p class="text-gray-600 mt-1">제품을 선택하고 견적을 요청하세요</p>
      </div>

      <div class="relative w-full md:w-96 group">
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
        <input
          type="text"
          id="searchInput"
          placeholder="상품명으로 검색..."
          class="w-full pl-10 pr-4 py-2 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-400 transition-all text-gray-900 placeholder:text-gray-400"
        />
      </div>
    </div>

    <!-- Category Tabs -->
    <div id="categoryTabs" class="flex flex-wrap gap-2">
      <!-- Categories will be rendered by JavaScript -->
    </div>

    <!-- Product Count & Pagination Info -->
    <div id="productInfo" class="flex items-center justify-between">
      <p class="text-gray-600 text-sm">총 <span id="totalCount" class="font-bold text-blue-600">0</span>개 상품</p>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-500">페이지당</span>
        <select id="pageSize" onchange="changePageSize()" class="px-3 py-1 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20">
          <option value="20">20개</option>
          <option value="50">50개</option>
          <option value="100">100개</option>
        </select>
      </div>
    </div>

    <!-- Table Container -->
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-lg transition-shadow">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
              <th class="px-6 py-4 font-semibold text-sm text-gray-700">상품정보</th>
              <th class="px-6 py-4 font-semibold text-sm text-gray-700">상품코드</th>
              <th class="px-6 py-4 font-semibold text-sm text-gray-700">가격</th>
              <th class="px-6 py-4 font-semibold text-sm text-gray-700">수량 선택</th>
              <th class="px-6 py-4 font-semibold text-sm text-gray-700 text-right">견적 담기</th>
            </tr>
          </thead>
          <tbody id="productTable" class="divide-y divide-gray-100">
            <!-- Products will be rendered here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination"></div>
  </div>

  <!-- Quote Bar (Fixed Bottom) -->
  <div id="quoteBar" class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 shadow-lg z-50 hidden">
    <div class="max-w-6xl mx-auto flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-6">
        <div>
          <span class="text-orange-100 text-sm">선택 품목</span>
          <p id="cartCount" class="text-xl font-bold">0개</p>
        </div>
        <div>
          <span class="text-orange-100 text-sm">총 수량</span>
          <p id="cartQuantity" class="text-xl font-bold">0개</p>
        </div>
        <div>
          <span class="text-orange-100 text-sm">예상 금액</span>
          <p id="cartTotal" class="text-xl font-bold">0원</p>
        </div>
      </div>
      <div class="flex gap-3">
        <button onclick="clearCart()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors">
          초기화
        </button>
        <button onclick="openModal()" class="px-6 py-2 bg-white text-orange-600 hover:bg-orange-50 rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
          <i data-lucide="file-text" class="w-4 h-4"></i>
          견적서 요청
        </button>
      </div>
    </div>
  </div>

  <!-- Quote Modal -->
  <div id="quoteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl flex justify-between items-center">
        <h2 class="text-xl font-bold">견적서 요청</h2>
        <button onclick="closeModal()" class="p-1 hover:bg-white/20 rounded-lg transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6 space-y-6">
        <!-- Selected Products -->
        <div>
          <h3 class="font-semibold text-gray-900 mb-3">선택한 상품</h3>
          <div class="border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left font-medium text-gray-600">상품명</th>
                  <th class="px-4 py-2 text-right font-medium text-gray-600">단가</th>
                  <th class="px-4 py-2 text-center font-medium text-gray-600">수량</th>
                  <th class="px-4 py-2 text-right font-medium text-gray-600">금액</th>
                  <th class="px-4 py-2 w-10"></th>
                </tr>
              </thead>
              <tbody id="modalCartItems" class="divide-y divide-gray-100">
                <!-- Cart items will be rendered here -->
              </tbody>
              <tfoot class="bg-blue-50 font-bold">
                <tr>
                  <td colspan="3" class="px-4 py-3 text-right text-gray-700">합계</td>
                  <td id="modalTotal" class="px-4 py-3 text-right text-blue-600 text-lg">0원</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Customer Form -->
        <div>
          <h3 class="font-semibold text-gray-900 mb-3">고객 정보</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                이름 / 회사명 <span class="text-red-500">*</span>
              </label>
              <input type="text" id="customerName" placeholder="홍길동 / ABC 주식회사"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                이메일 <span class="text-red-500">*</span>
              </label>
              <input type="email" id="customerEmail" placeholder="example@email.com"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                연락처 <span class="text-red-500">*</span>
              </label>
              <input type="tel" id="customerPhone" placeholder="010-1234-5678"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">추가 요청사항</label>
              <textarea id="customerMessage" placeholder="납기일, 배송지 등 추가 요청사항을 입력해주세요." rows="3"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 resize-none"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          취소
        </button>
        <button onclick="submitQuote()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
          <i data-lucide="send" class="w-4 h-4"></i>
          견적 요청하기
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom spacer when quote bar is visible -->
  <div id="bottomSpacer" class="h-24 hidden"></div>

  <script>
    // products and categories are loaded from external JS files
    let cart = [];
    let quantities = {};
    let searchKeyword = '';
    let currentPage = 1;
    let pageSize = 20;
    let selectedCategory = null;

    // Initialize quantities
    products.forEach(p => quantities[p.product_no] = 1);

    // Render category tabs
    function renderCategories() {
      const container = document.getElementById('categoryTabs');
      let html = `<button onclick="filterCategory(null)" class="category-btn px-4 py-2 rounded-lg text-sm font-medium transition-all ${selectedCategory === null ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-200'}">전체</button>`;

      categories.forEach(cat => {
        html += `<button onclick="filterCategory(${cat.category_no})" class="category-btn px-4 py-2 rounded-lg text-sm font-medium transition-all ${selectedCategory === cat.category_no ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-200'}">${cat.category_name}</button>`;
      });

      container.innerHTML = html;
    }

    // Filter by category
    function filterCategory(categoryNo) {
      selectedCategory = categoryNo;
      currentPage = 1;
      renderCategories();
      renderProducts();
    }

    // Format currency
    function formatPrice(price) {
      return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(price);
    }

    // Get filtered products
    function getFilteredProducts() {
      let filtered = products;

      // Category filter
      if (selectedCategory !== null) {
        filtered = filtered.filter(p => {
          // 상품에 category_no 필드가 있으면 사용
          if (p.category_no) return p.category_no === selectedCategory;
          // 없으면 상품명에서 카테고리 키워드 검색
          const cat = categories.find(c => c.category_no === selectedCategory);
          if (cat) {
            const name = p.product_name.toLowerCase();
            const catName = cat.category_name.toLowerCase();
            return name.includes(catName) || name.includes(catName.split('/')[0]);
          }
          return false;
        });
      }

      // Search filter
      if (searchKeyword) {
        const keyword = searchKeyword.toLowerCase();
        filtered = filtered.filter(p =>
          p.product_name.toLowerCase().includes(keyword) ||
          p.product_code.toLowerCase().includes(keyword)
        );
      }
      return filtered;
    }

    // Render products with pagination
    function renderProducts() {
      const tbody = document.getElementById('productTable');
      const filtered = getFilteredProducts();

      // Update total count
      document.getElementById('totalCount').textContent = filtered.length;

      // Paginate
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageProducts = filtered.slice(startIndex, endIndex);

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-20 text-center text-gray-500">
              검색 결과가 없습니다.
            </td>
          </tr>
        `;
        renderPagination(0);
        return;
      }

      tbody.innerHTML = pageProducts.map(product => {
        const isInCart = cart.some(item => item.product.product_no === product.product_no);
        const price = parseFloat(product.price) || 0;
        const priceDisplay = price > 0 ? formatPrice(price) : '<span class="text-gray-400">가격문의</span>';

        return `
          <tr class="hover:bg-blue-50/50 transition-colors group ${isInCart ? 'bg-green-50' : ''}">
            <td class="px-6 py-4">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden flex-shrink-0 border border-gray-200 flex items-center justify-center text-xs text-gray-400">
                  ${product.detail_image ? `<img src="${product.detail_image}" alt="" class="w-full h-full object-cover" onerror="this.style.display='none'" />` : ''}
                </div>
                <span class="font-semibold text-sm text-gray-900 group-hover:text-blue-600 transition-colors">
                  ${product.product_name}
                </span>
              </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 font-mono">${product.product_code}</td>
            <td class="px-6 py-4 font-bold text-gray-900 whitespace-nowrap">${priceDisplay}</td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2 bg-gray-100 w-fit rounded-lg p-1 border border-gray-200">
                <button onclick="updateQuantity(${product.product_no}, -1)" class="p-1.5 hover:bg-white rounded transition-colors text-gray-600">
                  <i data-lucide="minus" class="w-3 h-3"></i>
                </button>
                <span class="w-8 text-center text-sm font-bold text-gray-900">${quantities[product.product_no] || 1}</span>
                <button onclick="updateQuantity(${product.product_no}, 1)" class="p-1.5 hover:bg-white rounded transition-colors text-gray-600">
                  <i data-lucide="plus" class="w-3 h-3"></i>
                </button>
              </div>
            </td>
            <td class="px-6 py-4 text-right">
              <button onclick="addToCart(${product.product_no})" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all shadow-sm active:scale-95 ${isInCart ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-orange-500 hover:bg-orange-600 text-white'}">
                <i data-lucide="plus" class="w-4 h-4"></i>
                ${isInCart ? '추가 담기' : '견적 담기'}
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination(filtered.length);
      lucide.createIcons();
    }

    // Render pagination
    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / pageSize);
      const container = document.getElementById('pagination');
      if (!container) return;

      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '<div class="flex items-center justify-center gap-2 mt-6">';

      // Previous button
      html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
        class="px-3 py-1 rounded-lg border ${currentPage === 1 ? 'text-gray-300 cursor-not-allowed' : 'hover:bg-gray-100'}">
        <i data-lucide="chevron-left" class="w-4 h-4"></i>
      </button>`;

      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) {
        html += `<button onclick="goToPage(1)" class="px-3 py-1 rounded-lg border hover:bg-gray-100">1</button>`;
        if (startPage > 2) html += `<span class="px-2">...</span>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button onclick="goToPage(${i})"
          class="px-3 py-1 rounded-lg border ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span class="px-2">...</span>`;
        html += `<button onclick="goToPage(${totalPages})" class="px-3 py-1 rounded-lg border hover:bg-gray-100">${totalPages}</button>`;
      }

      // Next button
      html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
        class="px-3 py-1 rounded-lg border ${currentPage === totalPages ? 'text-gray-300 cursor-not-allowed' : 'hover:bg-gray-100'}">
        <i data-lucide="chevron-right" class="w-4 h-4"></i>
      </button>`;

      html += '</div>';
      container.innerHTML = html;
      lucide.createIcons();
    }

    function goToPage(page) {
      const totalPages = Math.ceil(getFilteredProducts().length / pageSize);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderProducts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSize').value);
      currentPage = 1;
      renderProducts();
    }

    // Update quantity
    function updateQuantity(productNo, delta) {
      quantities[productNo] = Math.max(1, (quantities[productNo] || 1) + delta);
      renderProducts();
    }

    // Add to cart
    function addToCart(productNo) {
      const product = products.find(p => p.product_no === productNo);
      const qty = quantities[productNo] || 1;

      const existing = cart.find(item => item.product.product_no === productNo);
      if (existing) {
        existing.quantity += qty;
      } else {
        cart.push({ product, quantity: qty });
      }

      quantities[productNo] = 1;
      updateQuoteBar();
      renderProducts();
    }

    // Remove from cart
    function removeFromCart(productNo) {
      cart = cart.filter(item => item.product.product_no !== productNo);
      updateQuoteBar();
      renderModalCart();
      renderProducts();
    }

    // Update cart quantity in modal
    function updateCartQuantity(productNo, delta) {
      const item = cart.find(i => i.product.product_no === productNo);
      if (item) {
        item.quantity = Math.max(1, item.quantity + delta);
        updateQuoteBar();
        renderModalCart();
      }
    }

    // Clear cart
    function clearCart() {
      cart = [];
      updateQuoteBar();
      renderProducts();
    }

    // Update quote bar
    function updateQuoteBar() {
      const quoteBar = document.getElementById('quoteBar');
      const bottomSpacer = document.getElementById('bottomSpacer');

      if (cart.length > 0) {
        quoteBar.classList.remove('hidden');
        bottomSpacer.classList.remove('hidden');

        const totalItems = cart.length;
        const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalAmount = cart.reduce((sum, item) => sum + (parseFloat(item.product.price) || 0) * item.quantity, 0);

        document.getElementById('cartCount').textContent = `${totalItems}개`;
        document.getElementById('cartQuantity').textContent = `${totalQty}개`;
        document.getElementById('cartTotal').textContent = `${totalAmount.toLocaleString('ko-KR')}원`;
      } else {
        quoteBar.classList.add('hidden');
        bottomSpacer.classList.add('hidden');
      }

      lucide.createIcons();
    }

    // Search with debounce
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchKeyword = e.target.value;
        currentPage = 1;
        renderProducts();
      }, 300);
    });

    // Modal functions
    function openModal() {
      document.getElementById('quoteModal').classList.remove('hidden');
      renderModalCart();
    }

    function closeModal() {
      document.getElementById('quoteModal').classList.add('hidden');
    }

    function renderModalCart() {
      const tbody = document.getElementById('modalCartItems');
      const totalAmount = cart.reduce((sum, item) => sum + (parseFloat(item.product.price) || 0) * item.quantity, 0);

      tbody.innerHTML = cart.map(item => {
        const price = parseFloat(item.product.price) || 0;
        const subtotal = price * item.quantity;
        return `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-gray-900 font-medium">${item.product.product_name}</td>
          <td class="px-4 py-3 text-right text-gray-700">${price > 0 ? price.toLocaleString('ko-KR') + '원' : '가격문의'}</td>
          <td class="px-4 py-3">
            <div class="flex items-center justify-center gap-1">
              <button onclick="updateCartQuantity(${item.product.product_no}, -1)" class="p-1 hover:bg-gray-200 rounded text-gray-600">
                <i data-lucide="minus" class="w-3 h-3"></i>
              </button>
              <span class="w-8 text-center font-bold text-gray-900">${item.quantity}</span>
              <button onclick="updateCartQuantity(${item.product.product_no}, 1)" class="p-1 hover:bg-gray-200 rounded text-gray-600">
                <i data-lucide="plus" class="w-3 h-3"></i>
              </button>
            </div>
          </td>
          <td class="px-4 py-3 text-right font-bold text-gray-900">${subtotal > 0 ? subtotal.toLocaleString('ko-KR') + '원' : '-'}</td>
          <td class="px-4 py-3">
            <button onclick="removeFromCart(${item.product.product_no})" class="p-1 hover:bg-red-100 text-red-500 rounded">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </td>
        </tr>
      `}).join('');

      document.getElementById('modalTotal').textContent = `${totalAmount.toLocaleString('ko-KR')}원`;
      lucide.createIcons();
    }

    function submitQuote() {
      const name = document.getElementById('customerName').value;
      const email = document.getElementById('customerEmail').value;
      const phone = document.getElementById('customerPhone').value;
      const message = document.getElementById('customerMessage').value;

      if (!name || !email || !phone) {
        alert('필수 정보를 입력해주세요.');
        return;
      }

      const totalAmount = cart.reduce((sum, item) => sum + (parseFloat(item.product.price) || 0) * item.quantity, 0);

      alert(`견적 요청이 접수되었습니다!\n\n담당자가 ${email}로 견적서를 보내드립니다.\n\n선택 품목: ${cart.length}개\n총 금액: ${totalAmount.toLocaleString('ko-KR')}원`);

      // Reset
      cart = [];
      document.getElementById('customerName').value = '';
      document.getElementById('customerEmail').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('customerMessage').value = '';
      closeModal();
      updateQuoteBar();
      renderProducts();
    }

    // Initialize
    renderCategories();
    renderProducts();
    lucide.createIcons();
  </script>
</body>
</html>
